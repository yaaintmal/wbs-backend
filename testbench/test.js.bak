// const express = require("express");
// const multer = require("multer");
// const sharp = require("sharp");
// const path = require("path");
// const fs = require("fs");
import { fileURLToPath } from "url";
import { dirname } from "path";
import swaggerUI from "swagger-ui-express";
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// using import instead of require
import express from "express";
import multer from "multer";
import sharp from "sharp";
import path from "path";
import fs from "fs";

const app = express();
const PORT = 3009;
const UPLOAD_DIR = path.join(__dirname, "uploads");
const FILE_SIZE_LIMIT = 5 * 1024 * 1024; // 5 MB

// using express.static
app.use("/media", express.static(UPLOAD_DIR));
app.use("/docs", swaggerUI.serve, swagerUI.setup(swaggerSpec));

// multer config: Nur für temporären Speicher (memoryStorage)
// Die Datei wird im RAM gehalten, bis Sharp sie verarbeitet.
const upload = multer({
  storage: multer.memoryStorage(),
  limits: {
    fileSize: FILE_SIZE_LIMIT,
  },
  fileFilter: (req, file, cb) => {
    // Strenge Validierung des MIME-Typs
    if (file.mimetype.startsWith("image/")) {
      cb(null, true);
    } else {
      cb(new Error("Nur Bilddateien sind erlaubt."), false);
    }
  },
});

/*
 * Best-Practice Middleware: Transformation und Speicherung
 * Nimmt den Buffer (req.file.buffer) und speichert die optimierte Version
 */
const imageProcessor = async (req, res, next) => {
  if (!req.file) {
    return next(); // Weiter, falls kein File hochgeladen wurde
  }

  const file = req.file;
  const fileName = `${path.parse(file.originalname).name}-${Date.now()}.webp`;
  const filePath = path.join(UPLOAD_DIR, fileName);

  try {
    // using sharp
    await sharp(file.buffer)
      .resize(800, 600, {
        fit: sharp.fit.inside, // scaling to 800x600, nocrop ish
        withoutEnlargement: true, // Nicht vergrößern, falls kleiner!? macht das Sinn? :
      })
      .webp({ quality: 80 }) // In modernes WebP-Format mit 80% Qualität konvertieren
      .toFile(filePath);

    // speichern
    req.uploadedFileUrl = `/media/${fileName}`;
    next();
  } catch (error) {
    console.error("Sharp Processing Error:", error);
    next(new Error("Fehler bei der Bildverarbeitung."));
  }
};

// api route for posting stuff
app.post(
  "/api/upload",
  upload.single("image"), // Multer empfängt das File und speichert es im RAM
  imageProcessor, // Sharp verarbeitet das File und speichert es auf der Platte
  (req, res) => {
    if (!req.uploadedFileUrl) {
      return res.status(400).json({
        message: "Keine Datei hochgeladen oder Verarbeitung fehlgeschlagen.",
      });
    }

    // successful res
    res.status(201).json({
      message: "Datei erfolgreich hochgeladen und optimiert.",
      publicUrl: req.uploadedFileUrl, // Die URL für das <img src="..."> Tag
    });
  }
);

// err-handling and stuff
app.use((err, req, res, next) => {
  console.error(err.stack);
  res.status(500).json({
    message: err.message || "Ein unbekannter Serverfehler ist aufgetreten.",
  });
});

// do upload exists?
if (!fs.existsSync(UPLOAD_DIR)) {
  fs.mkdirSync(UPLOAD_DIR);
}

app.listen(PORT, () => {
  console.log(`Server läuft auf http://localhost:${PORT}`);
  console.log(`Swagger UI läuft auf http://localhost:${PORT}/docs`);
});
